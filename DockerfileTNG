FROM ruby:2.3.4-alpine AS prereqs
MAINTAINER Ben Titcomb <btitcomb@scpr.org>

RUN apk update && apk add --no-cache \
  make \
  gcc \
  libgcc \
  g++ \
  libc-dev \
  libffi-dev \
  git \
  ruby-json \
  yaml \
  zlib-dev \
  libxml2-dev \
  libxslt-dev \
  tzdata \
  yaml-dev \
  openrc \
  nodejs



FROM prereqs AS dependencies

ENV HOME /home/assethost
ENV PATH="${HOME}/bin:${PATH}"
WORKDIR $HOME

COPY Gemfile .
COPY Gemfile.lock .
COPY frontend/package.json .
COPY frontend/package-lock.json .

ENV BUNDLE_PATH=/home/assethost/.bundle/

RUN mkdir /home/assethost/.bundle \
    && bundle install --without development test \
    && npm install



FROM ruby:2.3.4-alpine AS precompile

ENV HOME /home/assethost
ENV PATH="${HOME}/bin:${PATH}"
WORKDIR $HOME
ENV BUNDLE_PATH=/home/assethost/.bundle/

COPY . .
COPY --from=dependencies /home/assethost/node_modules/ frontend/
COPY --from=dependencies /home/assethost/.bundle/ /home/assethost/.bundle/
COPY --from=dependencies /usr/local/bundle/ /usr/local/bundle/
COPY --from=dependencies /usr/local/lib/ruby/gems/ /usr/local/lib/ruby/

RUN ls \
    && apk update && apk add --no-cache nodejs git tzdata \
    && bundle install \
    && bundle exec rake resources:precompile RAILS_ENV=production \
    && rm -rf frontend/node_modules



FROM ruby:2.3.4-alpine AS finish

ENV HOME /home/assethost
ENV PATH="${HOME}/bin:${PATH}"
WORKDIR $HOME
ENV BUNDLE_PATH=/home/assethost/.bundle/

COPY --from=precompile /home/assethost/ .
COPY --from=dependencies /home/assethost/.bundle/ /home/assethost/.bundle/
COPY --from=dependencies /usr/local/bin/rake /user/local/bin/
COPY --from=dependencies /usr/local/lib/ruby/gems/ /usr/local/lib/ruby/

RUN apk update && apk add --no-cache \
  imagemagick \
  exiftool \
  nginx \
  && addgroup -S assethost && adduser -S -g assethost assethost \
  && rm -rf tmp/* && rm -rf log/* \
  && cp nginx.conf /etc/nginx/nginx.conf \
  # forward request and error logs to docker log collector
  && ln -sf /dev/stdout /var/log/nginx/access.log \
  && ln -sf /dev/stderr /var/log/nginx/error.log \
  && ln -sf /dev/stdout log/access.log \
  && ln -sf /dev/stderr log/error.log \
  && touch log/development.log \
  && touch log/production.log \
  && ln -sf /dev/stdout log/development.log \
  && ln -sf /dev/stdout log/production.log \
  && chown -R assethost:assethost tmp \
  && chmod -R u+X tmp \
  && chown -R assethost:assethost log \
  && chmod -R u+X tmp \
  && chown -R assethost:assethost db \
  && chmod -R u+X db \
  && chown -R assethost:assethost /var/log/nginx/ \
  && chmod -R u+X /var/log/nginx/


USER assethost

EXPOSE 8080

CMD server

